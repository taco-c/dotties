#!/bin/sh

# Backweb: Set the BACKground image from a WEBcam!

# Defaults before reading from the config file.
url=""
name=""
blurlvl="2"
convert_opt=""
minutes="60"

config_file="$XDG_CONFIG_HOME/backweb.conf"
dir="$XDG_DATA_HOME/backweb"
file_name="$dir/img-$name"

[ -f "$config_file" ] && . "$config_file" || [ -f "$HOME/.config/backweb.conf" ] && . "$HOME/.config/backweb.conf" || exit
[ ! -d "$dir" ] && mkdir -p "$dir"

convert_opt="$convert_opt -resize x768 -blur x$blurlvl -paint $blurlvl"

update() {
	[ -f "$file_name.png" ] && feh --bg-fill "$file_name.png"
	[ "$INTERNET_IS_PRECIOUS" = "true" ] && [ "$1" != "force" ] && exit
	curl -s "$url" > "$file_name.jpg"
	[ "$?" = 0 ] && convert "$file_name.jpg" $convert_opt "$file_name.png" && feh --bg-fill "$file_name.png"
	cp "$file_name.png" "$dir/img.png"
}

while :; do
	[ "$1" = "force" ] && update force && break
	update
	[ "$1" = "once" ] && break
	sleep "${minutes}m"
done
